name: Android Build & Upload to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: stable
          architecture: x64

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Read App Version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}')
          echo "APP_VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build APK (Release)
        run: flutter build apk --release

      - name: Prepare APK Name + Download URL
        id: prep
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          APK_NAME="demo-app-${{ steps.version.outputs.APP_VERSION }}-${TIMESTAMP}.apk"
          echo "APK_NAME=$APK_NAME" >> $GITHUB_OUTPUT

          DOWNLOAD="https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/${{ secrets.AZURE_CONTAINER }}/${{ secrets.AZURE_DIRECTORY }}/$APK_NAME?${{ secrets.AZURE_SAS_TOKEN_READONLY }}"
          echo "DOWNLOAD_URL=$DOWNLOAD" >> $GITHUB_OUTPUT

      - name: Upload APK to Azure Blob
        run: |
          curl -X PUT \
            "https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/${{ secrets.AZURE_CONTAINER }}/${{ secrets.AZURE_DIRECTORY }}/${{ steps.prep.outputs.APK_NAME }}?${{ secrets.AZURE_UPLOAD_SAS_TOKEN }}" \
            -H "x-ms-blob-type: BlockBlob" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary "@build/app/outputs/flutter-apk/app-release.apk" \
            --fail-with-body

      - name: Send Email Notification
        if: success()
        run: |
          python3 << 'EOF'
          import smtplib
          from email.mime.text import MIMEText

          sender = "${{ secrets.EMAIL_USERNAME }}"
          password = "${{ secrets.EMAIL_APP_PASSWORD }}"

          receivers = [
              "${{ secrets.RECIPIENT_EMAIL_1 }}",
              "${{ secrets.RECIPIENT_EMAIL_2 }}"
          ]

          subject = "New APK Uploaded - Version ${{ steps.version.outputs.APP_VERSION }}"

          body = f"""
          New Android APK has been uploaded.

          Version: ${{ steps.version.outputs.APP_VERSION }}
          APK Name: ${{ steps.prep.outputs.APK_NAME }}

          Download (Read-Only Token Included):
          ${{ steps.prep.outputs.DOWNLOAD_URL }}

          Regards,
          CI/CD Pipeline
          """

          msg = MIMEText(body)
          msg["From"] = sender
          msg["To"] = ", ".join(receivers)
          msg["Subject"] = subject

          server = smtplib.SMTP("${{ secrets.SMTP_SERVER }}", int("${{ secrets.SMTP_PORT }}"))
          server.starttls()
          server.login(sender, password)
          server.sendmail(sender, receivers, msg.as_string())
          server.quit()
          EOF
