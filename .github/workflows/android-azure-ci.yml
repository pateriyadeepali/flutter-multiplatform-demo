name: Android Build & Upload to Azure Blob

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  STORAGE_ACCOUNT: epsazureblob
  CONTAINER_NAME: github-artifacts-container
  DIRECTORY: demo-flutter-app-dir
  FLUTTER_VERSION: '3.35.6'

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
        # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

        # Dynamic version extract from pubspec.yaml
      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "VERSION_NUMBER=$VERSION" >> $GITHUB_ENV
          echo "App Version: $VERSION"

        # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          architecture: x64

        # Install dependencies
      - name: Install Flutter dependencies
        run: flutter pub get

        # Build APK
      - name: Build Android release APK
        run: flutter build apk --release

        # Rename APK with version + timestamp
      - name: Rename APK
        run: |
          TS=$(date +'%Y%m%d_%H%M%S')
          NEW_NAME="demo-app-${{ env.VERSION_NUMBER }}-${TS}.apk"
          mv build/app/outputs/flutter-apk/app-release.apk $NEW_NAME
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

        # Upload to Azure Blob Storage
      - name: Upload APK to Azure Blob
        run: |
          curl -X PUT \
            -T "${{ env.APK_NAME }}" \
            "https://${{ env.STORAGE_ACCOUNT }}.blob.core.windows.net/${{ env.CONTAINER_NAME }}/${{ env.DIRECTORY }}/${{ env.APK_NAME }}${{ secrets.AZURE_SAS_TOKEN }}"

        # Send Email Notification
      - name: Send Email Notification
        run: |
          python3 - << 'EOF'
          import smtplib
          from email.mime.text import MIMEText

          sender = "${{ secrets.SMTP_USERNAME }}"
          recipients = "${{ secrets.RECIPIENT_EMAILS }}".split(",")

          apk_url = f"https://${{ env.STORAGE_ACCOUNT }}.blob.core.windows.net/${{ env.CONTAINER_NAME }}/${{ env.DIRECTORY }}/${{ env.APK_NAME }}${{ secrets.AZURE_SAS_TOKEN }}"

          body = f"""
          Hello Team,

          A new Android APK build is ready.

          Version: {{"${{ env.VERSION_NUMBER }}"}}  
          File Name: {{"${{ env.APK_NAME }}"}}  

          Download Link (with SAS token):
          {apk_url}

          Regards,
          CI/CD Automation
          """

          msg = MIMEText(body)
          msg["Subject"] = f"New APK Build Uploaded â€” Version ${{ env.VERSION_NUMBER }}"
          msg["From"] = sender
          msg["To"] = ", ".join(recipients)

          with smtplib.SMTP("${{ secrets.SMTP_SERVER }}", int("${{ secrets.SMTP_PORT }}")) as server:
              server.starttls()
              server.login(sender, "${{ secrets.SMTP_PASSWORD }}")
              server.sendmail(sender, recipients, msg.as_string())
          EOF

